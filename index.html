<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link
      rel="shortcut icon"
      href="https://tcb.cloud.tencent.com/dev-platform/1.2.130/assets/logo.0143704b.svg"
      mce_href="https://tcb.cloud.tencent.com/dev-platform/1.2.130/assets/logo.0143704b.svg"
      type="image/x-icon"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <title>欢迎使用云托管</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Droid Sans",
          "Helvetica Neue", "PingFang SC", "Hiragino Sans GB",
          "Droid Sans Fallback", "Microsoft YaHei", sans-serif;
      }

      .title-logo {
        width: 80px;
        height: 80px;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      @media screen and (min-width: 1200px) {
        body .container {
          margin-top: 160px;
          margin-bottom: 272px;
        }
      }

      @media screen and (max-width: 1919px) {
        body .container {
          margin-top: 76px;
          margin-bottom: 128px;
        }
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .count-button {
        width: 320px;
        height: 40px;
        box-sizing: border-box;
        margin: 16px 8px;
        font-weight: 500;
        font-size: 17px;
        color: #ffffff;
        letter-spacing: 1px;
        text-align: center;
        border-radius: 4px;
      }

      .count-number {
        align-self: flex-start;
        opacity: 0.9;
        font-weight: 500;
        font-size: 14px;
        color: #000000;
      }

      .count-reset {
        color: #576b95;
        cursor: pointer;
        margin-left: auto;
      }

      .count-text {
        width: 320px;
        height: 40px;
        padding: 0 12px;
        margin: 0 auto;
        line-height: 40px;
        text-align: left;
        display: flex;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        opacity: 0.9;
        box-sizing: border-box;
        font-weight: 400;
        font-size: 14px;
        color: #000000;
      }

      .quote {
        font-size: 12px;
      }

      .qrcode {
        height: 144px;
        width: 144px;
        display: block;
        margin: 0 auto;
      }

      .title {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        width: 320px;
      }

      .title-text {
        width: 320px;
        height: 48px;
        text-align: center;
        margin-top: 16px;
        font-size: 32px;
        opacity: 0.9;
        font-weight: 500;
        font-size: 32px;
        color: #000000;
        letter-spacing: 0;
        line-height: 48px;
      }

      .counter-container {
        margin-top: 48px;
      }

      .hr {
        text-align: center;
        position: relative;
        z-index: 2;
        height: 20px;
        line-height: 20px;
      }

      .hr::after {
        position: absolute;
        content: "";
        top: 10px;
        left: 60px;
        width: 200px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        z-index: -1;
      }

      .hr small {
        display: inline-block;
        background-color: white;
      }

      .hr-text {
        display: inline-block;
        height: 20px;
        font-weight: 400;
        font-size: 14px;
        color: rgba(0, 0, 0, 0.55);
        letter-spacing: 0;
        text-align: center;
        z-index: 2;
        background-color: white;
        padding: 0 8px;
        line-height: 20px;
      }

      .link-button {
        width: 154px;
        height: 48px;
        box-sizing: border-box;
        font-weight: 400;
        font-size: 14px;
        color: rgba(0, 0, 0, 0.9);
        letter-spacing: 0;
        text-align: center;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card {
        margin-top: 16px;
        width: 320px;
        height: 200px;
        box-sizing: border-box;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 5.71px;
        position: relative;
      }

      .card-text {
        text-align: center;
        font-weight: 400;
        font-size: 14px;
        color: rgba(0, 0, 0, 0.55);
        letter-spacing: 0;
      }

      .db-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 12px;
        border-radius: 4px;
        margin: 16px 0;
        width: 320px;
        text-align: center;
        font-size: 14px;
      }

      .db-warning .warning-icon {
        color: #f39c12;
        margin-right: 8px;
      }

      .db-warning .config-link {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
      }

      .test-card {
        width: 720px;
        max-width: calc(100vw - 32px);
        margin-bottom: 16px;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .pre-box {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 6px;
        padding: 12px;
        font-size: 12px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="title">
        <img
          class="title-logo"
          src="https://tcb.cloud.tencent.com/dev-platform/1.2.130/assets/logo.0143704b.svg"
        />
        <div style="display: inline; margin-bottom: 48px" class="title-text">
          欢迎使用云托管
        </div>
      </div>

      <!-- 数据库连接状态提示 -->
      <div id="db-warning" class="db-warning" style="display: none">
        <span class="warning-icon">⚠️</span>
        <span>数据库连接失败，请检查数据库连接配置</span>
        <span class="config-link" onclick="showConfigHelp()"
          >点击查看配置说明</span
        >
      </div>

      <div
        style="
          text-align: center;
          display: flex;
          flex-direction: column;
          align-items: center;
          margin: 0;
        "
      >
        <div class="card" style="width: 320px; margin-bottom: 16px">
          <div class="card-body">
            <div class="mb-3">
              <label for="sku-id" class="form-label">SKU ID（_id 字段）</label>
              <input
                type="text"
                class="form-control"
                id="sku-id"
                placeholder="输入 shop_sku 的 _id"
              />
            </div>
            <div class="mb-3">
              <label for="sku-delta" class="form-label"
                >变动库存数量（可为负数）</label
              >
              <input
                type="number"
                class="form-control"
                id="sku-delta"
                placeholder="例如 10 或 -5"
              />
            </div>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateSkuStock()"
              id="update-button"
            >
              更新库存
            </button>
            <div
              id="update-result"
              style="margin-top: 8px; font-size: 12px; color: #555"
            ></div>
          </div>
        </div>

        <div class="card test-card">
          <div class="card-body">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
              "
            >
              <div style="font-weight: 600">下单接口测试</div>
              <div style="font-size: 12px; color: rgba(0, 0, 0, 0.55)">
                POST <span class="mono">/api/shop/orders</span>
              </div>
            </div>

            <div style="margin-top: 10px; font-size: 12px; color: rgba(0, 0, 0, 0.55)">
              必填字段：<span class="mono">clientOrderNo</span>、<span class="mono">orderItems</span>（非空数组，每项必填 <span class="mono">skuId</span> 与 <span class="mono">count</span>，且数量为正整数）
            </div>

            <div class="mt-3">
              <label for="order-body" class="form-label"
                >请求 Body（JSON）</label
              >
              <textarea
                class="form-control mono"
                id="order-body"
                rows="10"
                placeholder='{"clientOrderNo":"...","userId":"","addressId":"","orderItems":[{"skuId":"...","count":1,"distributionRecordId":""}]}'
              ></textarea>
            </div>

            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 12px;
              "
            >
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="generateOrderBodyExample()"
                id="order-generate-button"
              >
                生成示例
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="formatOrderBodyJson()"
              >
                格式化
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="submitOrderRequest()"
                id="order-submit-button"
              >
                发送请求
              </button>
            </div>

            <div style="margin-top: 10px; font-size: 12px; color: #555" id="order-result"></div>

            <div class="mt-3">
              <div style="font-size: 12px; color: rgba(0, 0, 0, 0.55); margin-bottom: 6px">
                响应结果
              </div>
              <pre class="pre-box mono" id="order-response"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script
    src="https://code.jquery.com/jquery-1.12.4.min.js"
    integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"
  ></script>
  <script>
    let dbConnected = false;
    const apiBase = (function () {
      if (window.location.protocol === "file:") {
        return "http://127.0.0.1:8082";
      }
      return "";
    })();

    init();

    function init() {
      checkDBStatus();
    }

    function checkDBStatus() {
      $.ajax("http://127.0.0.1:8082/api/status", {
        method: "get",
      })
        .done(function (res) {
          if (res && res.data) {
            dbConnected = res.data.connected;
            updateUI();
          }
        })
        .fail(function () {
          dbConnected = false;
          updateUI();
        });
    }

    function updateUI() {
      if (!dbConnected) {
        $("#db-warning").show();
        $("#update-button").prop("disabled", true).css("opacity", "0.5");
        $("#order-submit-button").prop("disabled", true).css("opacity", "0.5");
      } else {
        $("#db-warning").hide();
        $("#update-button").prop("disabled", false).css("opacity", "1");
        $("#order-submit-button").prop("disabled", false).css("opacity", "1");
      }
    }

    function updateSkuStock() {
      if (!dbConnected) {
        alert("数据库未连接，请先检查配置");
        return;
      }

      const skuId = ($("#sku-id").val() || "").trim();
      const deltaStr = $("#sku-delta").val();
      const delta = Number(deltaStr);

      if (!skuId || !deltaStr) {
        alert("请填写 SKU ID 和变动数量");
        return;
      }

      if (!Number.isFinite(delta)) {
        alert("变动数量必须为数字");
        return;
      }

      $("#update-result").text("请求中...");

      $.ajax(apiBase + "/api/shop_sku/update-count", {
        method: "POST",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        data: JSON.stringify({
          skuId: skuId,
          delta: delta,
        }),
      })
        .done(function (res) {
          if (res && res.code === 0) {
            $("#update-result").text(
              "更新成功，SKU: " + res.data.skuId + "，变动数量: " + res.data.delta
            );
          } else {
            $("#update-result").text(
              "更新失败: " + (res && res.message ? res.message : "未知错误")
            );
          }
        })
        .fail(function () {
          $("#update-result").text("请求失败，请检查网络连接");
        });
    }

    function generateClientOrderNo() {
      const rand = Math.random().toString(16).slice(2, 10);
      return "test_" + Date.now() + "_" + rand;
    }

    function generateOrderBodyExample() {
      const example = {
        clientOrderNo: generateClientOrderNo(),
        userId: "",
        addressId: "",
        orderItems: [{ skuId: "", count: 1, distributionRecordId: "" }],
      };
      $("#order-body").val(JSON.stringify(example, null, 2));
      $("#order-result").text("");
      $("#order-response").text("");
    }

    function formatOrderBodyJson() {
      const raw = ($("#order-body").val() || "").trim();
      if (!raw) {
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        $("#order-body").val(JSON.stringify(parsed, null, 2));
        $("#order-result").text("");
      } catch (error) {
        $("#order-result").text("格式化失败：JSON 解析错误");
      }
    }

    function submitOrderRequest() {
      if (!dbConnected) {
        alert("数据库未连接，请先检查配置");
        return;
      }

      const raw = ($("#order-body").val() || "").trim();
      if (!raw) {
        alert("请填写请求 Body（JSON）");
        return;
      }

      let payload;
      try {
        payload = JSON.parse(raw);
      } catch (error) {
        alert("JSON 解析失败，请检查格式");
        return;
      }

      $("#order-result").text("请求中...");
      $("#order-response").text("");

      $.ajax("http://127.0.0.1:8082/api/shop/orders", {
        method: "POST",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        data: JSON.stringify(payload),
      })
        .done(function (res) {
          $("#order-result").text(res && res.code === 0 ? "请求成功" : "请求失败");
          $("#order-response").text(JSON.stringify(res, null, 2));
        })
        .fail(function (xhr) {
          const text = xhr && xhr.responseText ? xhr.responseText : "";
          let shown = text;
          try {
            shown = JSON.stringify(JSON.parse(text), null, 2);
          } catch (e) {}
          $("#order-result").text("请求失败");
          $("#order-response").text(shown || "请求失败，请检查网络连接");
        });
    }

    function showConfigHelp() {
      const helpText = `数据库配置说明：

方式 1.（推荐，适用于云托管部署）进入服务详情页，选择更新服务，在高级设置区块配置环境变量

   MYSQL_USERNAME=你的数据库用户名
   MYSQL_PASSWORD=你的数据库密码
   MYSQL_ADDRESS=数据库地址:端口 (如: localhost:3306)
   MYSQL_DATABASE=数据库名称

方式 2.（本地开发）在项目根目录创建/修改 .env 文件，内容同上（注意不要把 .env 提交到仓库）

完成后部署服务即可。`;

      alert(helpText);
    }
  </script>
</html>
